#source https://grafana.com/docs/alloy/latest/collect/logs-in-kubernetes/
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-configmap
  namespace: alloy
data:
  values.yaml: |
    alloy:
      securityContext:
        privileged: true
        runAsUser: 0
      mounts:
        dockercontainers: true
        varlog: true
      listenAddr: 0.0.0.0
      listenPort: 12345
      configMap:
        create: true
        name: alloy-configmap
        content: |-
          // Remote Write to Mimir UNIX
          prometheus.exporter.unix "integrations_node_exporter" {
            disable_collectors = ["ipvs", "btrfs", "infiniband", "xfs", "zfs"]
            enable_collectors = ["meminfo"]

            filesystem {
              fs_types_exclude     = "^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|tmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$"
              mount_points_exclude = "^/(dev|proc|run/credentials/.+|sys|var/lib/docker/.+)($|/)"
              mount_timeout        = "5s"
            }

            netclass {
              ignored_devices = "^(veth.*|cali.*|[a-f0-9]{15})$"
            }
            netdev {
              device_exclude = "^(veth.*|cali.*|[a-f0-9]{15})$"
            }
          }
          // There are two discovery.relabel components in this configuration. This discovery.relabel component replaces the instance and job labels that come in from the node_exporter with the hostname of the machine and a standard job name for all metrics.
          discovery.relabel "integrations_node_exporter" {
            targets = prometheus.exporter.unix.integrations_node_exporter.targets

            rule {
              target_label = "instance"
              replacement  = sys.env("HOSTNAME")
            }

            rule {
              target_label = "job"
              replacement = "integrations/node_exporter"
            }
          }

          prometheus.scrape "integrations_node_exporter" {
            scrape_interval = "10s"
                    targets    = discovery.relabel.integrations_node_exporter.output
                    forward_to = [prometheus.remote_write.metrics_service.receiver]
          }

          prometheus.remote_write "metrics_service" {
            endpoint {
              url = "http://mimir-mimir-gateway.mimir.svc.cluster.local/api/v1/push"
              headers = {
              }
              tls_config {
                insecure_skip_verify = false
              }
              send_native_histograms = false

              queue_config {
                capacity = 10000
                min_shards = 1
                max_shards = 50
                max_samples_per_send = 2000
                batch_send_deadline = "5s"
                min_backoff = "30ms"
                max_backoff = "5s"
                retry_on_http_429 = true
                sample_age_limit = "0s"
              }

              write_relabel_config {
                source_labels = ["cluster"]
                regex = ""
                replacement = "default"
                target_label = "cluster"
              }
              write_relabel_config {
                source_labels = ["k8s_cluster_name"]
                regex = ""
                replacement = "default"
                target_label = "k8s_cluster_name"
              }
            }

            wal {
              truncate_frequency = "2h"
              min_keepalive_time = "5m"
              max_keepalive_time = "8h"
            }
          }



























          